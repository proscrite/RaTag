# Data Persistence and Plotting Guide

This document describes all data storage formats and plot outputs generated by the RaTag analysis pipeline.

## Overview

The pipeline automatically saves:
1. **Raw data** (NPY arrays for fast access)
2. **Metadata** (JSON files with analysis parameters and results)
3. **Diagnostic plots** (PNG images for visual validation)

All outputs are organized in the run directory structure with a dedicated `plots/` subdirectory.

---

## Data Storage Formats

### Per-Set Data

Each set directory contains:

#### 1. S2 Integration Results
- **`s2_areas.npy`**: Raw S2 area array (NumPy)
- **`s2_results.json`**: Complete metadata including:
  ```json
  {
    "method": "integration_method_name",
    "params": {...},
    "mean": 1.234,
    "sigma": 0.123,
    "ci95": 0.241,
    "fit_success": true,
    "set_metadata": {
      "t_s1": 10.5,
      "t_s1_std": 0.3,
      "t_s2_start_mean": 45.2,
      "t_s2_start_std": 1.1,
      "t_s2_end_mean": 46.3,
      "t_s2_end_std": 1.2,
      "s2_duration_mean": 1.1,
      "s2_duration_std": 0.15,
      "drift_field": 250.0,
      "EL_field": 3000.0,
      "time_drift": 35.0,
      "speed_drift": 0.04,
      "red_drift_field": 125.0
    }
  }
  ```

#### 2. X-ray Classification Results
- **`xray_areas.npy`**: Accepted X-ray S2 areas (NumPy)
- **`xray_results.json`**: Event-by-event classification log:
  ```json
  {
    "set_id": "set_name",
    "params": {...},
    "n_events": 1000,
    "n_accepted": 850,
    "n_rejected": 150,
    "events": [
      {
        "wf_id": "waveform_001",
        "accepted": true,
        "reason": "passed_all_cuts",
        "area": 2.34
      },
      ...
    ]
  }
  ```

### Run-Level Data

In the run's `plots/` directory:

#### 3. Combined X-ray Data
- **`{run_id}_xray_areas_combined.npy`**: All X-ray areas from all sets
- **`{run_id}_xray_metadata.json`**: Summary statistics:
  ```json
  {
    "run_id": "RUN8",
    "n_areas": 8500,
    "sets": ["set1", "set2", ...],
    "mean": 2.45,
    "std": 0.32
  }
  ```

---

## Diagnostic Plots

All plots are saved as PNG images (150 DPI) in the `plots/` directory.

### Per-Set Plots

For each measurement set, the pipeline generates:

#### 1. S2 Area Histogram (`{set_name}_s2_histogram.png`)
- **Content**: Histogram of ion recoil S2 areas with Gaussian fit
- **Shows**:
  - Raw histogram (green bars)
  - Fitted Gaussian curve (red line)
  - Mean value with 95% CI (blue dashed line)
  - Axis labels with units (mV·µs)

#### 2. Waveform Validation (`{set_name}_waveform_validation.png`)
- **Content**: 10 randomly selected waveforms with timing markers
- **Shows** (for each waveform):
  - Individual waveform trace (NOT averaged, each in separate subplot)
  - S1 time mean (red dashed line)
  - S1 time 95% CI (red shaded region)
  - S2 start time mean (blue dashed line)
  - S2 start 95% CI (blue shaded region)
  - S2 end time mean (purple dashed line)
  - S2 end 95% CI (purple shaded region)
- **Purpose**: Visual validation that integration windows are correct

### Run-Level Plots

For the complete run:

#### 3. Combined X-ray Histogram (`{run_id}_xray_histogram.png`)
- **Content**: All X-ray events from all sets combined
- **Shows**:
  - Combined histogram (blue bars)
  - Gaussian fit (red curve)
  - Mean X-ray S2 area with CI (dark red dashed line)
  - Used for energy calibration

#### 4. S2 vs Drift Field - Unnormalized (`{run_id}_s2_vs_drift.png`)
- **Content**: Mean S2 area vs drift field
- **Shows**:
  - Data points with error bars (95% CI)
  - X-axis: Drift field (V/cm)
  - Y-axis: Mean S2 area (mV·µs)
  - One point per measurement set

#### 5. S2 vs Drift Field - Normalized (`{run_id}_s2_vs_drift_normalized.png`)
- **Content**: Normalized S2 area vs drift field
- **Shows**:
  - Data points with error bars
  - X-axis: Drift field (V/cm)
  - Y-axis: Normalized S2 Area (A_ion / A_xray)
  - Shows recombination effects clearly

#### 6. Diffusion Analysis (`{run_id}_diffusion_analysis.png`)
- **Content**: Three-panel figure showing S2 duration variance
- **Panel 1**: σ²_obs vs drift time (t_d)
  - Linear fit overlay showing diffusion coefficient
- **Panel 2**: σ²_obs vs t_d/v_d²
  - Normalized by drift speed squared
- **Panel 3**: σ²_obs vs reduced drift field (E/p)
  - Shows field-dependent diffusion
- **Purpose**: Extract transverse diffusion coefficient

---

## Critical Parameters Logged

All analysis parameters required to reproduce results are saved:

### Timing Parameters (per set, in s2_results.json)
- `t_s1`: S1 peak time (µs)
- `t_s1_std`: S1 timing uncertainty (µs)
- `t_s2_start_mean`: Mean S2 start time (µs)
- `t_s2_start_std`: S2 start timing spread (µs)
- `t_s2_end_mean`: Mean S2 end time (µs)
- `t_s2_end_std`: S2 end timing spread (µs)
- `s2_duration_mean`: Mean S2 window duration (µs)
- `s2_duration_std`: S2 duration variance (µs)

### Field Parameters (per set)
- `drift_field`: Drift field (V/cm)
- `EL_field`: Electroluminescence field (V/cm)
- `red_drift_field`: Reduced drift field (Td)

### Transport Parameters (per set)
- `time_drift`: Drift time (µs)
- `speed_drift`: Drift velocity (mm/µs)

### Integration Parameters (in s2_results.json)
- `method`: Integration method name
- `params`: Dictionary with:
  - `t_window`: (start, end) time window used
  - `n_pedestal`: Baseline samples
  - `ma_window`: Moving average window
  - `bs_threshold`: Baseline subtraction threshold
  - `dt`: Time sampling interval

### Fit Parameters (in s2_results.json)
- `mean`: Gaussian fit mean (mV·µs)
- `sigma`: Gaussian fit width (mV·µs)
- `ci95`: 95% confidence interval (mV·µs)
- `fit_success`: Boolean fit status

---

## Usage in Pipeline

The enhanced pipeline automatically handles all storage and plotting:

```python
from RaTag.pipeline import prepare_run, run_ion_integration, run_calibration_analysis

# Step 1: Prepare run (estimates S2 windows)
run = prepare_run(
    run,
    estimate_s2_windows=True,  # Compute S2 timing statistics
    flag_plot=False,           # No interactive plots during preparation
    nfiles=None                # Process all files
)

# Step 2: Ion integration (saves histograms + waveform validation)
fitted_areas = run_ion_integration(
    run,
    use_estimated_s2_windows=True,  # Use data-driven windows
    flag_plot=True,                 # Generate plots
    nfiles=None
)
# Automatically saved per set:
# - s2_areas.npy + s2_results.json (with complete metadata)
# - {set}_s2_histogram.png
# - {set}_waveform_validation.png
# 
# Automatically saved at run level:
# - {run_id}_s2_vs_drift.png

# Step 3: Calibration analysis (saves X-ray + diffusion plots)
calib_results, recomb_dict = run_calibration_analysis(
    run,
    ion_fitted_areas=fitted_areas,  # Or None to load from disk
    flag_plot=True,
    save_plots=True
)
# Automatically saved:
# - {run_id}_xray_areas_combined.npy + metadata.json
# - {run_id}_xray_histogram.png
# - {run_id}_s2_vs_drift_normalized.png
# - {run_id}_diffusion_analysis.png
```

---

## Data Reloading

All data can be reloaded without re-running the pipeline:

```python
from RaTag.dataIO import load_s2area
from RaTag.constructors import set_from_dir

# Load S2 results for a specific set
set_pmt = set_from_dir(Path("path/to/set"))
s2_data = load_s2area(set_pmt)

print(f"Mean: {s2_data.mean} ± {s2_data.ci95}")
print(f"S2 window: [{s2_data.params['set_metadata']['t_s2_start_mean']}, "
      f"{s2_data.params['set_metadata']['t_s2_end_mean']}]")

# Load combined X-ray data
import numpy as np
xray_areas = np.load("plots/RUN8_xray_areas_combined.npy")
```

---

## Directory Structure Example

After running the complete pipeline:

```
RUN8/
├── set1/
│   ├── *.wfm                          # Raw waveforms
│   ├── s2_areas.npy                   # S2 integration results
│   ├── s2_results.json                # Complete metadata
│   ├── xray_areas.npy                 # X-ray classification results
│   └── xray_results.json              # Event classification log
├── set2/
│   └── ...
├── plots/
│   ├── set1_s2_histogram.png          # Per-set histograms
│   ├── set1_waveform_validation.png   # Per-set waveform validation
│   ├── set2_s2_histogram.png
│   ├── set2_waveform_validation.png
│   ├── RUN8_xray_histogram.png        # Combined X-ray histogram
│   ├── RUN8_xray_areas_combined.npy   # Combined X-ray areas
│   ├── RUN8_xray_metadata.json        # X-ray statistics
│   ├── RUN8_s2_vs_drift.png          # Unnormalized results
│   ├── RUN8_s2_vs_drift_normalized.png # Normalized results
│   └── RUN8_diffusion_analysis.png    # Diffusion coefficient extraction
└── ...
```

---

## Notes

1. **JSON files** are human-readable and can be inspected with any text editor
2. **NPY files** are binary NumPy arrays for fast numerical processing
3. **PNG plots** at 150 DPI are suitable for both screen viewing and publication
4. All **timing parameters** are in microseconds (µs)
5. All **area values** are in mV·µs (voltage-time integrals)
6. The **waveform validation plots** show individual frames (not averaged) for FastFrame data

---

## Best Practices

1. **Always check waveform validation plots** after running the pipeline to ensure S2 windows are correct
2. **Save the complete directory structure** for reproducibility
3. **Use the JSON metadata** to document analysis parameters in publications
4. **The normalized S2 vs drift plot** is the primary physics result showing recombination
5. **Diffusion analysis plots** extract the transverse diffusion coefficient from S2 duration variance
